<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="microphone_loopback" />
<meta name="DC.relation" scheme="URI" content="GUID-408D6777-0172-406B-8442-B97FD5287AC8.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="microphone-loopback" />
<link rel="stylesheet" type="text/css" href="stylesheets/commonltr.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<link rel="stylesheet" type="text/css" href="./stylesheets/common-extended.css" /><title>microphone_loopback</title>
<meta name="Microsoft.Help.Id" content="GUID-32F3914E-5B2E-4D3C-898B-3A4760B287C7-microphone-loopback" />
<meta name="Microsoft.Help.TocParent" content="GUID-32F3914E-5B2E-4D3C-898B-3A4760B287C7" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB® Harmony Audio Apps Help Reference A 04/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
        function cpy(id, button) {
        
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                    button.textContent = "Copy";
                    button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
              console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
        }
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-9868F88F-53EE-443C-8987-C22CEBDCA6B2"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style></head>
<body id="microphone-loopback">
<h1 class="title topictitle1" id="ariaid-title1">microphone_loopback</h1><div class="body"><p class="p">This readme file provides instructions and information about the MPLAB Harmony 3 Microphone Loopback demonstration application, which is included in the MPLAB Harmony Library distribution.</p>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-408D6777-0172-406B-8442-B97FD5287AC8.html">Harmony 3 audio application examples</a></div>
</div>
</div><div class="topic nested1" aria-labelledby="ariaid-title2" id="description"><h2 class="title topictitle2" id="ariaid-title2">Description</h2><div class="body"><p class="p">In this demonstration application, the AK4954 or WM8904 Codec Driver sets up the codec so it can receive audio data through the microphone input on the daughter board and sends this same audio data back out through the on-board headphones, after a delay. The volume and delay are configurable using the on-board pushbutton. The audio by default is sampled at 48,000 samples per second, which is modifiable in the MHC as described below.</p>
<p class="p">To know more about the MPLAB Harmony Codec Drivers, configuring the Codec Drivers, and the APIs provided by the Codec Drivers, refer to Codec Driver Libraries.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title3" id="architecture"><h2 class="title topictitle2" id="ariaid-title3">Architecture</h2><div class="body"><p class="p">There are seven different projects packaged in this application.</p>
<p class="p"><strong class="ph b">PIC32 MZ EF Curiosity 2.0 Project:</strong></p>
<p class="p">One project runs on the PIC32 MZ EF Curiosity 2.0 board, using the PIC32MZ2048EFM144 microcontroller with 2 MB of Flash memory and 512 KB of RAM running at 198 MHz. The PIC32 MZ EF Curiosity 2.0 board includes the following features:</p>
<ul class="ul"><li class="li"><p class="p">Four push buttons (SW1-SW4, only SW1 is used)</p>
</li>
<li class="li"><p class="p">Four LEDs (LED1-LED4, only LED1 is used)</p>
</li>
<li class="li"><p class="p">AK4954 Codec Daughter Board mounted on X32 HEADER 2 socket
The PIC32 MZ EF Curiosity 2.0 board does not include the AK4954 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC324954.</p>
</li>
</ul>
<p class="p">The program takes up to approximately 2% (33 KB) of the PIC32MZ2048EFM144 microcontroller’s program space, and 55% (283 KB) of the RAM. No heap is used.</p>
<p class="p">The following figure illustrates the application architecture for the PIC32 MZ EF Curiosity 2.0 configuration:</p>
<br /><img class="image" src="GUID-A49CFE2F-1EC9-4454-8C78-0FBBEAB56E33-low.png" /><br /><p class="p"><strong class="ph b">SAM E54 Curiosity Ultra Projects:</strong></p>
<p class="p">Two projects run on the SAM E54 Curiosity Ultra Board, which contains a ATSAME54P20A microcontroller with 1 MB of Flash memory and 256 KB of RAM running at 48 MHz using the following features:</p>
<ul class="ul"><li class="li"><p class="p">Two push buttons (SW1 and SW2, only SW1is used)</p>
</li>
<li class="li"><p class="p">Two LEDs (LED1 and 2, only LED1 is used)</p>
</li>
<li class="li"><p class="p">WM8904 Codec Daughter Board mounted on a X32 socket</p>
</li>
</ul>
<p class="p">The SAM E54 Curiosity Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.</p>
<p class="p">The non-RTOS version of the program takes up to approximately 2% (23 KB) of the ATSAME54P20A microcontroller’s program space. The 16-bit configuration uses 45% (115 KB) of the RAM. No heap is used. For the FreeRTOS project, the program takes up to approximately 3% (31 KB) of the ATSAME54P20A microcontroller’s program space, and the 16-bit configuration uses 60% (155 KB) of the RAM. No heap is used.</p>
<p class="p">The following figure illustrates the application architecture for the two SAM E54 Xplained Ultra configurations (RTOS not shown):</p>
<br /><img class="image" src="GUID-84F95A67-F54D-4C68-97A4-59639EFA6DD3-low.png" /><br /><p class="p">The I2S (Inter-IC Sound Controller) is used with the WM8904 codec. The WM8904 is configured in master mode, meaning it generates the I2S clocks (LRCLK and BCLK), and the I2S peripheral is configured as a slave.</p>
<p class="p"><strong class="ph b">SAM E70 Xplained Ultra Projects:</strong></p>
<p class="p">Three projects run on the SAM E70 Xplained Ultra Board without a display, which contains a ATSAME70Q21B microcontroller with 2 MB of Flash memory and 384 KB of RAM running at 300 MHz using the following features:</p>
<ul class="ul"><li class="li"><p class="p">One push button (SW1, may be labeled as SW0 on some boards)</p>
</li>
<li class="li"><p class="p">Two LEDs (LED1 and 2, only LED1 is used)</p>
</li>
<li class="li"><p class="p">AK4954 or WM8904 Codec Daughter Board mounted on a X32 socket</p>
</li>
</ul>
<p class="p">The SAM E70 Xplained Ultra board does not include the AK4954 or WM8904 Audio Codec daughterboards, which are sold separately on microchipDIRECT as part numbers AC324954 and AC328904, respectively.</p>
<p class="p">The two non-RTOS versions of the program take up to approximately 1% (18 KB) of the ATSAME70Q21B microcontroller’s program space. The 16-bit configuration uses 30% (115 KB) of the RAM. No heap is used. For the FreeRTOS project, the program takes up to approximately 1% (22 KB) of the ATSAME70Q21B microcontroller’s program space, and the 16-bit configuration uses 41% (155 KB) of the RAM. No heap is used.</p>
<p class="p">The following figure illustrates the application architecture for the three SAM E70 Xplained Ultra configurations using the WM8904 (RTOS not shown). The AK4954 version is the same with the substitution of the AK4954 Driver and Codec blocks.</p>
<br /><img class="image" src="GUID-7B8EAA2C-95F1-4BE9-99EA-5C08F89934BB-low.png" /><br /><p class="p">The I2SC (Inter-IC Sound Controller) is used with the WM8904 codec, selected by a strapping option on the WM8904 daughterboard. The WM8904 is configured in slave mode and the I2SC peripheral is a master and generates the I2SC (LRCLK and BCLK) clocks. Other possible configurations are possible but not discussed.</p>
<p class="p"><strong class="ph b">SAM V71 Xplained Ultra Project:</strong></p>
<p class="p">This project runs on the SAM V71 Xplained Ultra Board, which contains a ATSAMV71Q21B microcontroller with 2 MB of Flash memory and 384 KB of RAM running at 300 MHz using the following features:</p>
<ul class="ul"><li class="li"><p class="p">Two push buttons (SW0 and 1, only SW0 used)</p>
</li>
<li class="li"><p class="p">Two LEDs (LED0 and 1, only LED0 used)</p>
</li>
<li class="li"><p class="p">WM8904 codec (on board)</p>
</li>
</ul>
<p class="p">The program takes up to approximately 1% (13 KB) of the ATSAME70Q21B microcontroller’s program space. The 16-bit configuration uses 74% (284 KB) of the RAM. No heap is used.</p>
<p class="p">The architecture is the same as for the first bare-metal SAM E70 Ultra board configuration; however only it uses the SSC peripheral instead of the I2SC. The WM8904 is configured in master mode and generates the I2SC (LRCLK and BCLK) clocks, and the I2SC peripheral is configured as a slave.</p>
<p class="p">Except for the user interface, the same application code is used without change between the various projects.</p>
<p class="p">The PIC32 or SAM microcontroller (MCU) runs the application code, and communicates with the AK4954 or WM8904 codec via an I2C interface. The audio interface between the microcontroller and the WM8904 codec use the I2S interface. Audio is configured as 16-bit, 48,000 or 16,000 samples per second, I2S format. (16-bit, 48 kHz is the standard rate used for DVD audio. 16 kHz still provides excellent voice quality audio. Another alternative that could be used is 44,100 samples per second. This is the same sample rate used for CD's.</p>
<p class="p">The Master Clock (MCLK) signal used by the codec is generated by the Generic Clock section of the E54, or the Peripheral Clock section of the SAM E70/V71, and is either 12 MHz (when the codec is configured as a master), or close to 12,288,000 (when the codec is configured as a slave, this frequency being 256 times the sample rate).</p>
<p class="p">The button and LEDs are interfaced using GPIO pins.</p>
<p class="p">As with any MPLAB Harmony application, the SYS_Initialize function, which is located in the initialization.c source file, makes calls to initialize various subsystems as needed, such as the clock, ports, board support package (BSP), screen (if applicable), AK4954 or WM8904 codec, I2S, I2C, DMA, timers, and interrupts.</p>
<p class="p">The codec driver and the application state machines are all updated through calls located in the SYS_Tasks function in the tasks.c file.</p>
<p class="p">When the application’s state machine (APP_Tasks), contained in app.c, is given control it first gets a handle to a timer driver instance and sets up a periodic (alarm) callback. In the next state it gets a handle to the codec driver by calling the</p>
<p class="p">DRV_CODEC_Open function with a mode of DRV_IO_INTENT_WRITE and sets up the volume. The application state machine then registers an event handler APP_CODEC_BufferEventHandler as a callback with the codec driver (which in turn is called by the DMA driver).</p>
<p class="p">A total of MAX_BUFFERS (#defined as 150) buffers are allocated, each able to hold 10 ms of audio (480 samples at 48,000 samples/second), which is enough for a 1.5 second delay.).</p>
<p class="p">Two indicies, appData.rxBufferIdx and appData.txBufferIdx are used to track the current buffers for both input and output. Initially all buffers are zeroed out. A call to DRV_CODEC_BufferAddWriteRead is made, which writes out the data from the buffer pointed to by appData.txBufferIdx (initially zero), while at the same time data is read from the codec into the buffer pointed to by appData.rxBufferIdx.</p>
<p class="p">On each callback from the DMA, the buffer pointers are advanced, wrapping around at the ends. After the prescribed delay, the audio from the first buffer filled in will be output.</p>
<p class="p">If the button is held down for more than one second, the mode changes, and there is no delay while the volume is being adjusted. Instead of a circular array of buffers, the first two buffers are just toggled back and forth in a ping-pong fashion.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title4" id="demonstration-features"><h2 class="title topictitle2" id="ariaid-title4">Demonstration Features</h2><div class="body"><ul class="ul"><li class="li"><p class="p">Uses the Codec Driver Library to input audio samples from the AK4954 or WM8904 codec, and later write them back out to the codec</p>
</li>
<li class="li"><p class="p">At a lower level, uses the I2S Driver Library between the codec library and the chosen peripheral (SSC or I2SC or I2S) to send the audio to the codec</p>
</li>
<li class="li"><p class="p">Using either an array of circular buffers to create an audio delay, or two buffers in ping-pong fashion for no delay, both using DMA</p>
</li>
<li class="li"><p class="p">Use of two timers: one as a periodic 1 ms timer for the application for button debouncing, and a second used by the Codec Driver (see Timer Driver Library)</p>
</li>
<li class="li"><p class="p">For the version using the display, use of the touch screen as a UI</p>
</li>
</ul>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title5" id="tools-setup-differences"><h2 class="title topictitle2" id="ariaid-title5">Tools Setup Differences</h2><div class="body"><p class="p"><strong class="ph b">For the project using the PIC32MZ, the I2S interface and the AK4954 as a Slave (the I2S peripheral generates the I2S clocks):</strong></p>
<p class="p">When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <em class="ph i">File &gt; New Project</em>. Chose the Configuration name based on the BSP. Select the appropriate processor (PIC32MZ2048EFM144). Click Finish.</p>
<p class="p">In the MHC, under Available Components select the PIC32 MZ EF Curiosity 2.0. Under <em class="ph i">Audio&gt;Templates</em>, double-click on AK4954 Codec. Answer Yes to all questions except for the one regarding FreeRTOS; answer No to that one.</p>
<p class="p">You should end up with a project graph that looks like this, after rearranging the boxes:</p>
<br /><img class="image" src="GUID-1AFA4DE6-4137-4B36-9A7F-371D54F888E4-low.png" /><br /><p class="p">Click on the I2S Peripheral. In the Configurations Options, under 32/16-Bit Communication Select bits, select (AUDEN=1) 24-bit data, 32-bit FIFO, 32-bit Channel/64-bit Frame. Change Master Clock Enable bit to REFCLK. Set the Frame Select Pin to C2 for the Curiosity 2.0 board. The configuration should look like this:</p>
<br /><img class="image" src="GUID-3C0E5F0C-F267-42F9-826E-CA7DB1531D95-low.png" /><br /><p class="p">Click on the I2C1 peripheral.  Tick the checkbox for the Include Force Write I2C Function:</p>
<br /><img class="image" src="GUID-C1CD2A47-DEBF-4F62-8E00-D6525EAED5C2-low.png" /><br /><p class="p">Under Tools, click on Clock Configuration. In the Clock Diagram:</p>
<ul class="ul"><li class="li"><p class="p">Change the Primary Oscillator frequency to 12,000,000 Hz, and select HS under POSCMOD.</p>
</li>
<li class="li"><p class="p">Change the FPLLRNG to 8-16 MHz, and FPLLMULT to MUL_33.</p>
</li>
<li class="li"><p class="p">In the Reference CLock section, check the ON and OE checkboxes,, and set ROTRIM1 to 29 and RODIV1 to 8. This should give a REFCLKO1 output of 12,288,000 Hz, which is 256 times the 48 KHz sample rate.</p>
</li>
</ul>
<p class="p">You should end up with a clock diagram like this:</p>
<br /><img class="image" src="GUID-E1D96BDE-F3B7-4677-B28E-43111C3A73C8-low.png" /><br /><p class="p"><strong class="ph b">For projects using the E54, the I2S interface and the WM8904 as a Master (the WM8904 codec generates the I2S clocks):</strong></p>
<p class="p">When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <em class="ph i">File &gt; New Project</em>. Chose the Configuration name based on the BSP. Select the appropriate processor (ATSAME54P20A). Click Finish.</p>
<p class="p">In the MHC, under Available Components select the BSP SAM E54 Curiosity Ultra. Under <em class="ph i">Audio&gt;Templates</em>, double-click on WM8904 Codec. Answer Yes to all questions. Click on the WM8904 Codec component (<em class="ph i">not</em> the WM8904 Driver). Answer Yes to all questions except for the one regarding FreeRTOS; answer Yes or No to that one depending on whether you will be using FreeRTOS or not.</p>
<p class="p">You should end up with a project graph that looks like this, after rearranging the boxes:</p>
<br /><img class="image" src="GUID-6610C007-6292-4F1A-A1A7-2DA28C86952F-low.png" /><br /><p class="p">Click on the WM8904 Driver. In the Configurations Options, under Audio Data Format, change it to 32-bit I2S. Set the desired Sample Rate if different from the default (48,000) under Sampling Rate.</p>
<p class="p">In the Clock Diagram:</p>
<ul class="ul"><li class="li"><p class="p">Set enable the Crystal Oscillator, change it frequency to 12,000,000 Hz, and select CRYSTAL.</p>
</li>
<li class="li"><p class="p">Uncheck the Fractional Digital Phase Locked Loop enable (FDPLL 0).</p>
</li>
<li class="li"><p class="p">In the CLK Generator 0 box, change the input to DFLL for an output of 48 MHz.</p>
</li>
<li class="li"><p class="p">In the CLK Generator 1 box, change the input to XOSC0 with a divider of 1 for an output of 12 MHz.</p>
</li>
<li class="li"><p class="p">In the GCLK Generator, uncheck the selection for GCLK 2, and then select the GCLK 3 tab. Choose the DFLL as the input, with a divide by 4 for an output of 12 MHz.</p>
</li>
</ul>
<p class="p">You should end up with a clock diagram like this:</p>
<br /><img class="image" src="GUID-A2A1F4F7-26EF-45B1-874F-82181F792DA6-low.png" /><br /><p class="p"><strong class="ph b">For projects using the E70, the SSC interface and the AK4954 as a Slave (the SAM E70 generates the I2S clocks):</strong></p>
<p class="p">When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <em class="ph i">File &gt; New Project</em>. Chose the Configuration name based on the BSP. Select the appropriate processor (ATSAME70Q21B). Click Finish.</p>
<p class="p">In the MHC, under Available Components select the BSP SAM E70 Xplained Ultra. Under <em class="ph i">Audio&gt;Templates</em>, double-click on AK4954 Codec. Answer Yes to all questions. Click on the AK4954 Codec component (<em class="ph i">not</em> the AK4954 Driver). In the Configuration Options, under AK4954 Interface, select I2SC instead of SSC. Answer Yes to all questions except for the one regarding FreeRTOS; answer Yes or No to that one depending on whether you will be using FreeRTOS or not.</p>
<p class="p">You should end up with a project graph that looks like this, after rearranging the boxes:</p>
<br /><img class="image" src="GUID-D7581170-9715-4655-B530-94EE0AA16D5A-low.png" /><br /><p class="p">Click on the AK4954 Driver. In the Configurations Options, under Usage Mode, change Master to Slave. Set the desired Sample Rate if different from the default (48,000) under Sampling Rate.</p>
<p class="p">In the Clock Diagram, set MOSCEL to Main Crystal, check the Bypass checkbox, and uncheck the RC Crystal Oscillator and Main Crystal Oscillator boxes, to make use of the 12 MHz external oscillator:</p>
<br /><img class="image" src="GUID-0EAEC30D-4C0F-4D5B-A359-34B6EA8C2504-low.png" /><br /><p class="p">Still in the Clock Diagram, enable the PLLA Clock. Leave the divider at 1 (12 MHz) and change the multiplier to 41 for an output of 492 MHz.</p>
<br /><img class="image" src="GUID-83211F46-2337-44DA-9CB4-B188056906DA-low.png" /><br /><p class="p">In the Master Clock Controller, select the source (CSS) as PLLACK (492 MHz), all all three dividers as divide by 2 to generate a Processor Clock of 246 MHz and a Master Clock of 123 MHz. In the Programmable Clock Controller section, select the PCK2 tab, select the source (CSS) as PLLACK (492 MHz), the divider of 40 for a PCK2 output of 12,300,000 Hz.</p>
<br /><img class="image" src="GUID-DC8AAD9E-A926-4216-AEF6-E80B7726CEAC-low.png" /><br /><p class="p">Then check the SSC checkbox in the <strong class="ph b">Peripheral Clock Controller</strong> section..</p>
<p class="p"><strong class="ph b">For projects using the I2SC interface and the WM8904 as a Slave (the SAM E70 generates the I2S clocks):</strong></p>
<p class="p">When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <em class="ph i">File &gt; New Project</em>. Chose the Configuration name based on the BSP. Select the appropriate processor (ATSAME70Q21B). (The WM8904 on the SAM V71 Xplained Ultra cannot be used with I2SC.) Click Finish.</p>
<p class="p">In the the MHC, under Available Components select the BSP SAM E70 Xplained Ultra. Under <em class="ph i">Audio&gt;Templates</em>, double-click on WM8904 Codec. Answer Yes to all questions. Click on the WM8904 Codec component (<em class="ph i">not</em> the WM8904 Driver). In the Configuration Options, under WM8904 Interface, select I2SC instead of SSC. Answer Yes to all questions except for the one regarding FreeRTOS; answer Yes or No to that one depending on whether you will be using FreeRTOS or not.</p>
<p class="p">You should end up with a project graph that looks like this, after rearranging the boxes, assuming a non-FreeRTOS project:</p>
<br /><img class="image" src="GUID-5F2AC87F-9428-4BF2-A19B-74A092BCCE08-low.png" /><br /><p class="p">Click on the WM8904 Driver. In the Configurations Options, under Usage Mode, change Master to Slave. Set the desired Sample Rate if different from the default (48,000) under Sampling Rate. Select Enable Microphone Input, and Enable Microphone Bias for elecret microphones if appropriate.</p>
<p class="p">If using the SAM E70 Xplained Ultra board, in the Clock Diagram, set MOSCEL to Main Crystal, check the Bypass checkbox, and uncheck the RC Crystal Oscillator and Main Crystal Oscillator boxes, to make use of the 12 MHz external oscillator:</p>
<br /><img class="image" src="GUID-7FE2C80F-C91E-46C4-9F94-3CBF384A9B07-low.png" /><br /><p class="p">In the Clock Diagram, in the PCK2 tab of the <strong class="ph b">Programmable Clock Controller</strong> section, check the <strong class="ph b">On</strong> checkbox, and set CSS to MAINCLK (12 MHz).</p>
<p class="p">The following tables show suggested settings for various sample rates in the Clock Diagram when using the I2SC Peripheral in Master mode. Make sure <strong class="ph b">PLLA Clock</strong> checkbox is checked, and fill in the values for the PLLA Multiplier and Divider boxes. Select the I2S1 tab under <strong class="ph b">Generic Clock Controller</strong>, set GCLKCSS to PLLACK, fill in the Divider value as shown, and check the checkbox next to it.</p>
<br /><img class="image" src="GUID-53E1D807-096B-4278-9DCF-9F7611A95DA4-low.png" /><br /><p class="p">The values in the first table give the lowest error rate, but have varying PLLACK values so it is best to use the UPPCLKDIV selection for CSS under <strong class="ph b">Master Clock Controller</strong>, for a Processor Clock of 240 MHz.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e346"><span><strong class="ph b">Desired Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e349"><span><strong class="ph b">PLLA Multipler</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e352"><span><strong class="ph b">PLLA Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e355"><span><strong class="ph b">PLLACK</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e358"><span><strong class="ph b">I2SC Generic Clock Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e361"><span><strong class="ph b">Calculated Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e364"><span><strong class="ph b">Error</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e346 "><span>8000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e349 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e352 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e355 "><span>258 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e358 "><span>126</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e361 "><span>7998</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e364 "><span>-0.025%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e346 "><span>16000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e349 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e352 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e355 "><span>258 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e358 "><span>63</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e361 "><span>15997</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e364 "><span>-0.0187%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e346 "><span>44100</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e349 "><span>1</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e352 "><span>16</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e355 "><span>192 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e358 "><span>17</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e361 "><span>41117</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e364 "><span>0.0385%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e346 "><span>48000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e349 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e352 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e355 "><span>258 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e358 "><span>21</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e361 "><span>47991</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e364 "><span>-0.0187%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e346 "><span>96000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e349 "><span>3</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e352 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e355 "><span>172 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e358 "><span>7</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e361 "><span>95982</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e364 "><span>-0.0187%</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p">The values in the second table have somewhat higher error rates, but use a PLLACK value of 294 MHz which is suitable to be used as a Processor Clock (using the PLLACK selection for CSS) which is closer to the maximum of 300 MHz.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e456"><span><strong class="ph b">Desired Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e459"><span><strong class="ph b">PLLA Multipler</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e462"><span><strong class="ph b">PLLA Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e465"><span><strong class="ph b">PLLACK</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e468"><span><strong class="ph b">I2SC Generic Clock Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e471"><span><strong class="ph b">Calculated Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e474"><span><strong class="ph b">Error</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e456 "><span>8000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e459 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e462 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e465 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e468 "><span>144</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e471 "><span>7975</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e474 "><span>-0.3125%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e456 "><span>16000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e459 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e462 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e465 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e468 "><span>72</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e471 "><span>15950</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e474 "><span>-0.3125%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e456 "><span>44100</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e459 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e462 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e465 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e468 "><span>26</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e471 "><span>41170</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e474 "><span>0.1587%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e456 "><span>48000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e459 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e462 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e465 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e468 "><span>24</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e471 "><span>47851</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e474 "><span>-0.3104%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e456 "><span>96000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e459 "><span>3</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e462 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e465 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e468 "><span>12</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e471 "><span>95703</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e474 "><span>-0.3094%</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p">It is also possible to change the audio format from 16 to 32-bits. This changes need to be done in the MHC in both the WM8904 Driver and SSC Peripheral. In the current application code (app.h), a #define is also set to the current width.</p>
<p class="p">If using FreeRTOS, in the code you will need to move the call to DRV_WM8904_Tasks(sysObj.drvwm8904Codec0); from the SYS_Tasks function in src/config/&lt;config_name&gt;/tasks.c to inside the while(1) loop of _APP_Tasks (just before the call to APP_Tasks).</p>
<p class="p"><strong class="ph b">For projects using the SSC interface and the WM8904 as a Master (the WM8904 codec generates the I2S clocks):</strong></p>
<p class="p">When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <em class="ph i">File &gt; New Project</em>. Chose the Configuration name same based on the BSP used. Select the appropriate processor (e.g. ATSAMV71Q21B) depending on your board. Click Finish.</p>
<p class="p">In the MHC, under Available Components select the appropriate BSP (e.g. SAM V71 Xplained Ultra). Under <em class="ph i">Audio&gt;Templates</em>, double-click on WM8904 Codec. Answer Yes to all questions except for the one regarding FreeRTOS; answer Yes or No to that one depending on whether you will be using FreeRTOS or not.</p>
<p class="p">You should end up with a project graph that looks like this, after rearranging the boxes, assuming a non-FreeRTOS project:</p>
<br /><img class="image" src="GUID-A2047C2D-2793-411E-92B3-6358A03C9049-low.png" /><br /><p class="p">If using the SAM E70 Xplained Ultra board, in the Clock Diagram, in the Clock Diagram, set MOSCEL to Main Crystal, check the Bypass checkbox, and uncheck the RC Crystal Oscillator and Main Crystal Oscillator boxes, to make use of the 12 MHz external oscillator:</p>
<br /><img class="image" src="GUID-7FE2C80F-C91E-46C4-9F94-3CBF384A9B07-low.png" /><br /><p class="p">If using the ATSAMV71Q21B, in the Clock Diagram set MOSCEL to Main Crystal, uncheck the Bypass checkbox and RC Crystal Oscillator checkbox, and check the Main Crystal Oscillator box.</p>
<p class="p">Also in the Clock Diagram, in the PCK2 tab of the <strong class="ph b">Programmable Clock Controller</strong> section, check the On checkbox, and set CSS to MAINCLK (12 MHz). Then check the SSC checkbox in the <strong class="ph b">Peripheral Clock Controller</strong> section.</p>
<p class="p">It is also possible to change the audio format from 16 to 32-bits, and from I2S to Left Justified (SSC only). These changes need to be done in the MHC in both the WM8904, and SSC/I2SC Peripherals. In the current application code (app.h), a #define is also set to the current width.</p>
<p class="p">If using FreeRTOS, in the code you will need to move the call to DRV_WM8904_Tasks(sysObj.drvwm8904Codec0); from the SYS_Tasks function in src/config/&lt;config_name&gt;/tasks.c to inside the while(1) loop of _APP_Tasks (just before the call to APP_Tasks).</p>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title6" id="building-the-application"><h3 class="title topictitle3" id="ariaid-title6">Building the Application</h3><div class="body"><p class="p">This section identifies the MPLAB X IDE project name and location and lists and describes the available configurations for the demonstration.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p">The parent folder for these files is audio/apps/audio_microphone_loopback. To build this project, you must open the audio/apps/audio/audio_microphone_loopback/firmware/*.X project file in MPLAB X IDE that corresponds to your hardware configuration.</p>
</div>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title7" id="mplab-x-ide-project-configurations"><h2 class="title topictitle2" id="ariaid-title7">MPLAB X IDE Project Configurations</h2><div class="body"><p class="p">The following table lists and describes supported configurations.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e615"><span><strong class="ph b">Project Name</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e618"><span><strong class="ph b">BSP Used</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e621"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e615 "><span>mic_loopback_ pic32mz_ef_c2_ ak4954</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e618 "><span>pic32mz_ef_curiosity_v2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e621 "><span>This demonstration runs on the PIC32MZ2048EFM144 processor on the PIC32 MZ EF Curiosity 2.0 board and the AK4954 Audio Codec Daughter Board. The configuration is for a 16-bit data width, 48000 Hz sampling frequency, and I2S audio protocol using the I2S PLIB. The AK4954 codec is configured as the slave, and the I2S peripheral as the master.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e615 "><span>mic_loopback_ sam_e54_cult_ wm8904_ssc</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e618 "><span>sam_e54_cult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e621 "><span>This demonstration runs on the ATSAME54P20A processor on the SAM E54 Curiosity Ultra board and the WM8904 Audio Codec Daughter Board. The configuration is for a 16-bit data width, 48000 Hz sampling frequency, and I2S audio protocol using the SSC PLIB. The WM8904 codec is configured as the master, and the SSC peripheral as the slave.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e615 "><span>mic_loopback_ sam_e54_cult_ wm8904_ssc_freertos</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e618 "><span>sam_e54_cult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e621 "><span>This demonstration runs on the ATSAME54P20A processor on the SAM E54 Curiosity Ultra board and the WM8904 Audio Codec Daughter Board. The configuration is for a 16-bit data width, 48000 Hz sampling frequency, and I2S audio protocol using the SSC PLIB. The WM8904 codec is configured as the master, and the SSC peripheral as the slave. This demonstration also uses FreeRTOS.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e615 "><span>mic_loopback_ sam_e70_xult_ ak4954_ssc</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e618 "><span>sam_e70_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e621 "><span>This demonstration runs on the ATSAME70Q21B processor on the SAM E70 Xplained Ultra board and the AK4954 Audio Codec Daughter Board. The configuration is for a 16-bit data width, 48000 Hz sampling frequency, and I2S audio protocol using the SSC PLIB. The AK4954 codec is configured as the slave, and the SSC peripheral as the master.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e615 "><span>mic_loopback_ sam_e70_xult _wm8904_i2sc</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e618 "><span>sam_e70_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e621 "><span>This demonstration runs on the ATSAME70Q21B processor on the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board. The configuration is for a 16-bit data width, 48000 Hz sampling frequency, and I2S audio protocol using the I2SC PLIB. The WM8904 codec is configured as the slave, and the I2SC peripheral as the master.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e615 "><span>mic_loopback_ sam_e70_xult_ wm8904_i2sc_freertos</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e618 "><span>sam_e70_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e621 "><span>This demonstration runs on the ATSAME70Q21B processor on the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board. The configuration is for a 16-bit data width, 48000 Hz sampling frequency, and I2S audio protocol using the I2SC PLIB. The WM8904 codec is configured as the slave, and the I2SC peripheral as the master. This demonstration also uses FreeRTOS.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e615 "><span>mic_loopback_ sam_v71_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e618 "><span>sam_v71_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e621 "><span>This demonstration runs on the ATSAMV71Q21B processor on the SAMV71 Xplained Ultra board along with the on-board WM8904 codec. The configuration is for a 16-bit data width, 48000 Hz sampling frequency, and I2S audio protocol using the SSC PLIB. The WM8904 codec is configured as the master, and the SSC peripheral as the slave.</span></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title8" id="configuring-the-hardware"><h3 class="title topictitle3" id="ariaid-title8">Configuring the Hardware</h3><div class="body"><p class="p">This section describes how to configure the supported hardware. SAM V71 Xplained Ultra board and the WM8904 Audio Codec Daughter Board, using the SSC PLIB. No configuration is necessary.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p">Using the PIC32 MZ EF Curiosity 2.0 board and the AK4954 Audio Codec Daughter Board, and I2S PLIB. The AK4954 daughter board is plugged into the set of X32 connectors on the right side of the board (X32 HEADER 2).</p>
<p class="p"><img class="image" src="GUID-58C1CE18-6C7A-4E0B-8B25-2FC7E9058754-low.png" /><br />  <strong class="ph b">Note:</strong> The PIC32 MZ EF Curiosity 2.0 does not include the AK4954 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC324954.</p>
<p class="p">Using the SAM E54 Curiosity Ultra board and the WM8904 Audio Codec Daughter Board, and the I2S PLIB. All jumpers on the WM8904 should be toward the <strong class="ph b">front:</strong></p>
<br /><img class="image" src="GUID-D793242C-642E-4657-B694-A4D8BB9C24E0-low.png" /><br /><p class="p">In addition, make sure the J401 jumper (CLK SELECT) is set for the PA17 pin:</p>
<br /><img class="image" src="GUID-6FB4EA50-5944-4421-9A18-87FEDC5A5844-low.png" /><br /><p class="p"><img class="image" src="GUID-58C1CE18-6C7A-4E0B-8B25-2FC7E9058754-low.png" /><br />  <strong class="ph b">Note:</strong> The SAM E54 Curiosity Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.</p>
<p class="p">Using the SAM E70 Xplained Ultra board and the AK4954 Audio Codec Daughter Board, and the SSC PLIB. No special configuration needed.</p>
<p class="p"><img class="image" src="GUID-58C1CE18-6C7A-4E0B-8B25-2FC7E9058754-low.png" /><br />  <strong class="ph b">Note:</strong> The SAM E70 Xplained Ultra board does not include the AK4954 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC324954.</p>
<p class="p">Using the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board, and the I2SC PLIB. All jumpers on the WM8904 should be toward the <strong class="ph b">back:</strong></p>
<br /><img class="image" src="GUID-461B2BE7-BDF4-4C69-A322-ADBA61089781-low.png" /><br /><p class="p"><img class="image" src="GUID-58C1CE18-6C7A-4E0B-8B25-2FC7E9058754-low.png" /><br /> <strong class="ph b">Note:</strong> The SAM E70 Xplained Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.</p>
<p class="p">Using the SAM V71 Xplained Ultra board with on-board WM8904, with the SSC PLIB. No special configuration needed.</p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title9" id="running-the-demonstration"><h3 class="title topictitle3" id="ariaid-title9">Running the Demonstration</h3><div class="body"><p class="p">This section demonstrates how to run the demonstration.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p"><img class="image" src="GUID-1E2D444E-70D8-4D19-83D5-CF548C1D60C3-low.png" /><br /> <strong class="ph b">Important!</strong> Prior to using this demonstration, it is recommended to review the MPLAB Harmony 3 Release Notes for any known issues.</p>
<p class="p">Compile the program using MPLAB X, and program the target device using the EDBG interface. While compiling, select the appropriate MPLAB X IDE project. Refer to Building the Application for details.</p>
<p class="p">Four different delays can be generated. <strong class="ph b">Tables 1-2</strong> provides a summary of the button actions that can used to control the volume and delay amount.</p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">Connect headphones to the HP OUT jack of the AK4954 or WM8904 Audio Codec Daughter Board (see <strong class="ph b">Figures 1-2</strong>), or the HEADPHONE jack of the SAM V71 Xplained Ultra board.</p>
</li>
<li class="li"><span class="indent-level-default">2.</span><p class="p">If applicable, connect a microphone to the MIC IN jack of the WM8904 Audio Codec Daughter Board, or the MICROPHONE jack of the SAM V71 Xplained Ultra board. (For the AK4954, the internal microphone contained on the daughterboard is used instead.)</p>
</li>
<li class="li"><span class="indent-level-default">3.</span><p class="p">The lowest-numbered pushbutton (SW0 or SW1) and LED are used as the user interface to control the program, as shown in Tables 1-3 below, depending on the board used. Initially the program will be in delay-setting mode (LED on) at a medium volume setting. Pressing the pushbutton with the LED on will cycle through four delay settings.</p>
</li>
<li class="li"><span class="indent-level-default">4.</span><p class="p">Pressing the pushbutton longer than one second will change to volume-setting mode (LED off). Pressing the pushbutton with the LED off will cycle through four volume settings (including mute). There is never any delay when setting the volume.</p>
</li>
<li class="li"><span class="indent-level-default">5.</span><p class="p">Pressing the pushbutton longer than one second again will switch back to delay-setting mode again (LED on).</p>
</li>
</ol>
</div>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title10" id="control-descriptions"><h2 class="title topictitle2" id="ariaid-title10">Control Descriptions</h2><div class="body"><br /><img class="image" src="GUID-FD9012DC-5F12-412D-A5D4-E8D417169590-low.png" /><br /></div>
<div class="topic nested2" aria-labelledby="ariaid-title11" id="figure-1-ak4954-audio-codec-daughter-board-on-pic32-mz-ef-curiosity-20-board"><h3 class="title topictitle3" id="ariaid-title11">Figure 1: AK4954 Audio Codec Daughter Board on PIC32 MZ EF Curiosity 2.0 Board</h3><div class="body"><br /><img class="image" src="GUID-F077C4EC-629E-47D5-9C18-573CBF3FF9D1-low.png" /><br /></div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title12" id="figure-2-wm8904-audio-codec-daughter-board-on-sam-e70-xplained-ultra-board"><h3 class="title topictitle3" id="ariaid-title12">Figure 2: WM8904 Audio Codec Daughter Board on SAM E70 Xplained Ultra board</h3><div class="body"></div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title13" id="table-1-button-controls-for-pic32mz-ef-curiosity-20-sam-e54-curiosity-ultra-board-and-sam-e70-xplained-ultra-board"><h3 class="title topictitle3" id="ariaid-title13">Table 1: Button Controls for PIC32MZ Ef Curiosity 2.0, SAM E54 Curiosity Ultra board and SAM E70 Xplained Ultra board</h3><div class="body"><p class="p">(On some E70 boards, SW0/LED0 are the lowest numbered pushbutton and LED, so use Table 3 instead.)</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e794"><span><strong class="ph b">Control</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e797"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e794 "><span>SW1 short press</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e797 "><span>If LED1 if off, SW1 cycles through four volume levels (one muted). If LED1 is on, SW1 cycles through four delays: ¼ second, ½ second, 1 second and 1½ seconds.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e794 "><span>SW1 long press (&gt; 1 second)</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e797 "><span>Alternates between modes (LED1 on or off).</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title14" id="table-2-button-controls-for-sam-v71-xplained-ultra-board"><h3 class="title topictitle3" id="ariaid-title14">Table 2: Button Controls for SAM V71 Xplained Ultra board</h3><div class="body">
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e821"><span><strong class="ph b">Control</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d2764e824"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e821 "><span>SW0 short press</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e824 "><span>If LED0 if off, SW0 cycles through four volume levels (one muted). If LED0 is on, SW0 cycles through four delays: ¼ second, ½ second, 1 second and 1½ seconds.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e821 "><span>SW0 long press (&gt; 1 second)</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d2764e824 "><span>Alternates between modes (LED0 on or off).</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</body>
</html>