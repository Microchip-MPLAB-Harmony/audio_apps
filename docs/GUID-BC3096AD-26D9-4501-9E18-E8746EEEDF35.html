<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="usb_speaker_hi_res" />
<meta name="DC.relation" scheme="URI" content="GUID-408D6777-0172-406B-8442-B97FD5287AC8.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="usb-speaker-hi-res" />
<link rel="stylesheet" type="text/css" href="stylesheets/commonltr.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<link rel="stylesheet" type="text/css" href="./stylesheets/common-extended.css" /><title>usb_speaker_hi_res</title>
<meta name="Microsoft.Help.Id" content="GUID-32F3914E-5B2E-4D3C-898B-3A4760B287C7-usb-speaker-hi-res" />
<meta name="Microsoft.Help.TocParent" content="GUID-32F3914E-5B2E-4D3C-898B-3A4760B287C7" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB® Harmony Audio Apps Help Reference A 04/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
        function cpy(id, button) {
        
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                    button.textContent = "Copy";
                    button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
              console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
        }
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-BC3096AD-26D9-4501-9E18-E8746EEEDF35"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style></head>
<body id="usb-speaker-hi-res">
<h1 class="title topictitle1" id="ariaid-title1">usb_speaker_hi_res</h1><div class="body"><p class="p">This topic provides instructions and information about the MPLAB Harmony 3 USB Speaker Hi-Res demonstration application, which is included in the MPLAB Harmony Library distribution.</p>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-408D6777-0172-406B-8442-B97FD5287AC8.html">Harmony 3 audio application examples</a></div>
</div>
</div><div class="topic nested1" aria-labelledby="ariaid-title2" id="description"><h2 class="title topictitle2" id="ariaid-title2">Description</h2><div class="body"><p class="p">This demonstration application configures the development board to implement a USB Speaker device configured to run at 96 Khz sampling rate at 24 bit per sample.</p>
<p class="p">The USB Device driver in Full Speed mode will interface to a USB Host (such as a personal computer) via the USB Device Stack using the V1.0 Audio Function Driver. The embedded system will enumerate with a USB audio device endpoint and enable the host system to input audio from the USB port using a standard USB Full-Speed implementation. The embedded system will stream USB playback audio to the Codec. The Codec Driver sets up the audio interface, timing, DMA channels and buffer queue to enable a continuous audio stream. The digital audio is transmitted to the codec through an I2S data module for playback through a headphone jack.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title3" id="architecture"><h2 class="title topictitle2" id="ariaid-title3">Architecture</h2><div class="body"><p class="p">The application runs on the SAM E70 Xplained Ultra Board, with the following features:</p>
<ul class="ul"><li class="li"><p class="p">One push button (SW1)</p>
</li>
<li class="li"><p class="p">Two LEDs (amber LED1 and green LED2). Only LED 1 can be used for a USB Device requiring VBUS sense.</p>
</li>
<li class="li"><p class="p">WM8904 Codec Daughter Board mounted on a X32 socket</p>
</li>
</ul>
<p class="p"><img class="image" src="GUID-2C84CAAE-0A8E-4E24-83A4-D5FA1219699A-low.png" /><br /> <strong class="ph b">Note:</strong> The SAM E70 Xplained Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.</p>
<p class="p">The hi-res application uses the MPLAB Harmony Configurator to setup the USB Audio Device, codec, and other items in order to play back the USB audio through the WM8904 Codec Module.</p>
<p class="p">A USB Host system is connected to the micro-mini USB device connector. The application detects the cable connection, which can also supply device power; recognizes the type of connection (Full Speed); enumerates its functions with the host, isochronous audio streaming playback through device. Audio stream data is buffered in 1 ms frames for playback using the WM8904 Codec daughter board. Audio is heard through the Headphone jack (HP OUT).</p>
<p class="p">The following figure shows the basic architecture for the demonstration.</p>
<br /><img class="image" src="GUID-FE85B817-2D4C-4490-A46F-61CA18D1BCFF-low.png" /><br /></div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title4" id="demonstration-features"><h2 class="title topictitle2" id="ariaid-title4">Demonstration Features</h2><div class="body"><ul class="ul"><li class="li"><p class="p">Playback using an WM8904 codec daughterboard on the SAM E70 xPlained Ultra (E70XULT) board.</p>
</li>
<li class="li"><p class="p">USB connection to a host system using the USB Library Device Stack for a USB Speaker device using E70XULT</p>
</li>
<li class="li"><p class="p">E70XULT Button processing for volume/mute control</p>
</li>
<li class="li"><p class="p">USB Attach/Detach and mute status using an LED.</p>
</li>
<li class="li"><p class="p">Utilization of the of I2S peripheral I2SC (as master)</p>
</li>
</ul>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title5" id="tools-setup-differences"><h2 class="title topictitle2" id="ariaid-title5">Tools Setup Differences</h2><div class="body"></div>
<div class="topic nested2" aria-labelledby="ariaid-title6" id="harmony-configuration"><h3 class="title topictitle3" id="ariaid-title6">Harmony Configuration</h3><div class="body"><p class="p">The MHC Project Graph for usb_speaker_hi-res is shown below.</p>
<p class="p">Each block provides configuration parameters to generate the application framework code. This includes all the needed drivers, middleware, libraries. The generated framework code is placed under the firmware/src/config directory for this usb_speaker application (usb_speaker_basic_sam_e70_xult_wm8904_usb). The usb_speaker_basic application code is located in the firmware/src directory app.c and app.h files, which utilize the framework drivers, middleware and library APIs located in definitions.h (as generated by the configurator).</p>
<br /><img class="image" src="GUID-BABEB6FC-ED95-44D3-90B9-E022AD7AB9D7-low.png" /><br /></div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title7" id="harmony-code-generation"><h3 class="title topictitle3" id="ariaid-title7">Harmony Code Generation</h3><div class="body"><p class="p">All Harmony applications use the function SYS_Initialize function located in the source file also located in initialization.c. This is executed from main to initialize various subsystems such as the clock, ports, BSP (board support package), codec, usb, timers, and interrupts. The application APP_Initialize function in app.c is also executed in this routine to setup the application code state machine.</p>
<p class="p">The USB, WM8904 driver, and the application state machines (APP_Tasks routine) are all updated via calls located in the function SYS_Tasks, executed from the main polling loop, located in tasks.c.</p>
<p class="p">The application code is contained in the standard source file app.c. The application utilizes a simple state machine (APP_Tasks executed from SYS_Tasks) with the following functions</p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">Setup the drivers and USB Library interface</p>
</li>
<li class="li"><span class="indent-level-default">2.</span><p class="p">Respond to USB Host control commands (�Attach�, �Detach�, �Suspend�)</p>
</li>
<li class="li"><span class="indent-level-default">3.</span><p class="p">Initiate and maintains the bidirectional data audio streaming for the "USB Playback" function.</p>
</li>
</ol>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title8" id="usb-configuration"><h3 class="title topictitle3" id="ariaid-title8">USB Configuration</h3><div class="body"><p class="p">The application uses USB Library as a "Device" stack, which will connect to a "Host". The USB High Speed Driver is selected to by �Full Speed� (not �High Speed�):</p>
<br /><img class="image" src="GUID-D3FE98E1-F3FD-493D-83B4-A77F00006498-low.png" /><br /><p class="p">The USB Device Layer is configured by selecting the �usb_speaker_demo� with an endpoint buffer size of 64 (bytes). The Audio</p>
<p class="p">Function Driver is configured for 5 USB endpoints with a single function having 3 interfaces. All of these are defined for a USB Speaker device in the fullSpeedConfigurationDescriptor array variable structure (located in initialization.c under the config folder).</p>
<p class="p">This structure defines the connection to the host at 96 Khz with 24 bit stereo channel data. A packet queue of length</p>
<p class="p">APP_QUEUE_SIZE (set to 32) is used for playback data. The maximum USB packets size is set to 96 * 3 channels/sample * 2 bytes/channel= 576 bytes, which gives a 1ms stereo sample packet size at 96 Khz (the standard data frame length at this rate), thus the buffer size needs to be of the same size.</p>
<p class="p">The Audio Function Driver is configured with a Audio Read Queue that matches that of the codec driver write queue for this Audio V1.0 USB Speaker interface.</p>
<br /><img class="image" src="GUID-5290BCF5-286F-49CD-A8B2-CFC458160E77-low.png" /><br /><p class="p">The Audio Function Driver is configured with a Audio Read Queue that matches that of the codec driver write queue for this Audio V1.0 USB Speaker interface.</p>
<br /><img class="image" src="GUID-3CBA122F-17FE-4739-A87E-8C82C83C8708-low.png" /><br /><p class="p"><strong class="ph b">Note:</strong> The USB Speaker selection generates a USB Full Speed Descriptor with an isochronous audio stream at 48 Khz/2 Channel/16 bits per channel. This code is modified manually to enumerate a 96Khz/ 2 Channel/ 24 bits per channel isochronous audio data stream.</p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title9" id="the-wm8904-codec"><h3 class="title topictitle3" id="ariaid-title9">The WM8904 Codec</h3><div class="body"><p class="p">The WM8904 codec uses a TWIHS (I2C) interface for configuration and control register setting and either a SSC for audio data or I2SC I2S interface. The default settings are used as shown below:</p>
<br /><img class="image" src="GUID-7C1200CD-EB1A-470E-894C-5A75A2C30047-low.png" /><br /><p class="p">The I2SC1 driver is in �Slave� mode, thus the codec usage mode changes to �Slave�</p>
<p class="p">The I2S configuration uses a Transfer queue size of 128, matching that that of the USB Read Queue:</p>
<br /><img class="image" src="GUID-14090022-397A-44FE-B813-08AECECF3322-low.png" /><br /><p class="p">The I2S data channel is 32 bit long, although only 24 bits is used. The DMA should be selected to match what is configured in the system block.</p>
<br /><img class="image" src="GUID-7F6A2760-24C3-4752-BFCE-347C7679103E-low.png" /><br /><p class="p">The I2SC1 driver is configured for 24 bit data, although a 32 bit channel frame is used. This implies that the 24 bit 3 byte packed data buffer received from the USB audio data stream must be unpacked to 32 bit words (4 byte), since a 24 bit frame is not available for the WM8904.</p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title10" id="pin-manager"><h3 class="title topictitle3" id="ariaid-title10">Pin Manager</h3><div class="body"><p class="p">The buttons, LED, Switch, I2S and I2C interfaces using GPIO pins via the Microchip Harmony Configurator (MHC) Pin Manager, as follows for the I2SC1:</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e165"><span><strong class="ph b">NAME</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e168"><span><strong class="ph b">PORT</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e171"><span><strong class="ph b">E70 PIN</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e174"><span><strong class="ph b">Notes</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>I2SC1_WS</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PE00</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>4</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2S LRCK (Word Select)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>I2SC1_DO0</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PE01</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>6</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2S DO (Data Out)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>I2SC1_DI0</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PE02</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>7</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2S DI (Data In)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>I2SC1_CK</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PA20</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>22</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2S BCLK (Bit Clock)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>I2SC1_GCLK</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PA19</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>23</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2S MCLK (Bit Clock as used by the E70 I2SC1, I2S Master)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>PMC_PCK2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PA18</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>24</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2S MCLK (Master Clock as used by the WM8904 Codec I2S Slave)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>SWITCH</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PA11</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>66</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>Push Button</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>LED1</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PA05</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>73</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>-</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>TWIHS0_TWCK0</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PA04</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>77</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2C</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>TWIHS0_TWD0</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PA03</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>91</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>I2C</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>STDBY</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PD11</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>98</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>-</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e165 "><span>LED2/VBUS DETECT(J204)</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e168 "><span>PB08</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e171 "><span>141</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e174 "><span>J204 set to VBUS DETECT for USB Device</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title11" id="clock-manager"><h3 class="title topictitle3" id="ariaid-title11">Clock Manager</h3><div class="body"><p class="p">All clocks are generated from the 12 MHz Main Clock oscillator. From this clock is derived the following clocks:</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e300"><span><strong class="ph b">Clock</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e303"><span><strong class="ph b">Value</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e306"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e300 "><span>HCLK</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e303 "><span>300 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e306 "><span>Processor Clock</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e300 "><span>PCK2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e303 "><span>12 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e306 "><span>Peripheral Clock 2</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e300 "><span>USB FS</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e303 "><span>48 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e306 "><span>USB Full Speed Clock</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p">The I2S clocks are setup for 48Khz sampling rate, with stereo 32 bit samples, giving a 64 bit stereo sample frame. The I2S clocks are generated from the WM8904 acting as I2S master using the 24.576 Mhz master clock obtained from I2SC1_GCLK. The I2S clocks will then be generated from the MCLK value below to approximate the following clock rates:</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e340"><span><strong class="ph b">I2S Function</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e343"><span><strong class="ph b">Value</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e346"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e340 "><span>LRCK</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e343 "><span>96.000000 K</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e346 "><span>Sample rate clock</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e340 "><span>BCLK</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e343 "><span>6114000 Hz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e346 "><span>Bit Rate Clock</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e340 "><span>MCLK</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e343 "><span>24.576000 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e346 "><span>Master Clock</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p"><strong class="ph b">MPLAB Harmony Configurator: Tools&gt;Clock Configuration</strong></p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title12" id="i2sc1-clock-configuration"><h3 class="title topictitle3" id="ariaid-title12">I2SC1 Clock Configuration</h3><div class="body"><p class="p">Uncheck the Main RC Oscillator and check the �Bypass� for the Main Crystal Oscillator. When the Bypass is checked, it will cause the Main Crystal Oscillator to become disabled. An external MEMS oscillator input on the XIN pin is used for Main Clock generation.</p>
<br /><img class="image" src="GUID-F201CD72-889F-405B-A8B0-5B5E2DBA5701-low.png" /><br /><p class="p"><em class="ph i">Clock Diagram&gt;Peripheral Clock Enable</em></p>
<p class="p">The I2SC1 master requires the I2SC1_GCLK generate an MCLK to approximate 24.576 hz. This clock is generated from the PLLA Clock (PLLACK), as shown below.</p>
<br /><img class="image" src="GUID-753E8D18-263A-43B3-8407-B8F1AD9B1D64-low.png" /><br /><br /><img class="image" src="GUID-7BEA749E-2D18-4F97-A941-EF9A4E43B8AB-low.png" /><br /><p class="p"><em class="ph i">I2SC1 Configuration of PLLA Clock (PLLACK)</em></p>
<p class="p"><em class="ph i">I2SC1 GCLK Configuration</em></p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title13" id="mplab-harmony-configurator-timer-driver-tc0"><h3 class="title topictitle3" id="ariaid-title13">MPLAB Harmony Configurator: Timer Driver (TC0)</h3><div class="body"><p class="p">The Timer driver configuration, Timer driver instance 0, is used by a system for button processing (debounce and long press) and LED blink delay. It needs to be set to �Enable Period Interrupt�.</p>
<br /><img class="image" src="GUID-BCF75618-45A3-48E5-BE97-44ABA0C661CD-low.png" /><br /></div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title14" id="building-the-application"><h3 class="title topictitle3" id="ariaid-title14">Building the Application</h3><div class="body"><p class="p">This section identifies the MPLAB X IDE project name and location and lists and describes the available configurations for the demonstration.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p">The parent folder for these files is audio/apps/usb_speaker_hi_res. To build this project, you must open the audio/apps/usb_speaker_hi_res/firmware/*.X project file in MPLAB X IDE that corresponds to your hardware configuration.</p>
<p class="p"><strong class="ph b">MPLAB X IDE Project</strong></p>
<p class="p">This table lists the name and location of the MPLAB X IDE project folder for the demonstration.</p>
</div>
<div class="topic nested3" aria-labelledby="ariaid-title15" id="mplab-x-ide-project-configurations"><h4 class="title topictitle4" id="ariaid-title15">MPLAB X IDE Project Configurations</h4><div class="body"><p class="p">This table lists and describes the supported configurations of the demonstration, which are located within ./firmware/src/config.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e430"><span><strong class="ph b">Project Name</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e433"><span><strong class="ph b">BSP Used</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e436"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e430 "><span>us_hi_res_basic_sam_e70_xult_ wm8904_i2sc_usb.X</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e433 "><span>sam_e70_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e436 "><span>This demonstration runs on the SAM E70 Xplained Ultra board with the WM8904 daughter board using the I2SC PLIB.</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title16" id="configuring-the-hardware"><h3 class="title topictitle3" id="ariaid-title16">Configuring the Hardware</h3><div class="body"><p class="p">This section describes how to configure the supported hardware.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p">Using the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board, using the I2SC PLIB:</p>
<p class="p">Jumper J204, which is next to the SAM E70 Xplained Ultra logo, should be jumpered for VBUS.</p>
<p class="p">To connect to the SSC, the jumpers (J6, J7, J8, and J9) on the WM8904 Codec Daughterboard must be oriented towards the pink, mic in, connector. See the red outlined jumpers in the below image as reference.</p>
<br /><img class="image" src="GUID-986BE7B4-D5F9-49A8-86FC-C6FF57A5F691-low.png" /><br /><p class="p"><img class="image" src="GUID-2C84CAAE-0A8E-4E24-83A4-D5FA1219699A-low.png" /><br /> <strong class="ph b">Note:</strong> The SAM E70 Xplained Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.</p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title17" id="running-the-application"><h3 class="title topictitle3" id="ariaid-title17">Running the Application</h3><div class="body"><p class="p">This section demonstrates how to run the demonstration.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p"><img class="image" src="GUID-FE0F1005-3364-4646-8DA6-ADCAD03B1483-low.png" /><br /> <strong class="ph b">Important!</strong> Prior to using this demonstration, it is recommended to review the MPLAB Harmony 3 Release Notes for any known issues.</p>
<p class="p">Compile and program the target device. While compiling, select the appropriate MPLAB X IDE project. Refer to Building the Application for details.</p>
<p class="p">Do the following to run the demonstration:</p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">Attach the WM8904 Daughter Board to the X32 connector. Connect headphones to the HP OUT (green) jack of the WM8904 Audio Codec Daughter Board (see <strong class="ph b">Figure 1</strong>).</p>
</li>
</ol>
<p class="p"><strong class="ph b">Important:</strong> The I2SC/SSC jumpers must be in the correct position for the configuration being run.</p>
<br /><img class="image" src="GUID-C26C7EC9-6358-428D-9914-0F240CFC3D8B-low.png" /><br /><p class="p"><em class="ph i">Figure 1. WM8904 Audio Codec Daughter Board on SAM E70 Xplained Ultra board. Headphone Out Jack is green.</em></p>
<p class="p"><em class="ph i">Note: the brown wire is a jumper which is not relevant for this app.</em></p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">Connect power to the board, compiles the application and program the target device. Run the device. The system will be in a waiting for USB to be connected (amber LED1 off).</p>
</li>
<li class="li"><span class="indent-level-default">2.</span><p class="p">Connect to the USB Host via the micro-mini connector located above the push-button switches on the right side of the board using a standard USB cable.</p>
</li>
<li class="li"><span class="indent-level-default">3.</span><p class="p">Allow the Host computer to acknowledge, install drivers (if needed), and enumerate the device. No special software is necessary on the Host side.</p>
</li>
</ol>
<br /><img class="image" src="GUID-8E0D73EB-DEE4-4762-AA72-7BDA7222D255-low.png" /><br /><p class="p"><em class="ph i">Figure 2. Windows 7 Sound Dialog showing USB Microphone with Sound Level Meter</em></p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">If needed, configure the Host computer to use the usb_speaker as the selected audio playback device. For Windows, this is done in the "Playback" tab in the "Sound" dialog (as shown in Figure 2) accessed by right clicking the loudspeaker icon in the taskbar.</p>
</li>
</ol>
<p class="p"><img class="image" src="GUID-2C84CAAE-0A8E-4E24-83A4-D5FA1219699A-low.png" /><br /> <strong class="ph b">Note:</strong> The device "Harmony USB Hi Res Speaker Example" should be available along with a sound level meter indication audio when playing. If no sound level is registering, uninstall the driver, since it may have incorrect configuration set by a similar connection to one of the other MPLAB-X Harmony Audio Demos. Disconnect and reconnect the usb cable to the PC. The reconfigured driver will then be installed for the correct USB device.</p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">Open a playback application (such as Window Media Player) and initiate playback through the USB Speaker</p>
</li>
<li class="li"><span class="indent-level-default">2.</span><p class="p">Playback will demonstrate that the audio is being heard in the USB Speaker headphones. Use the pushbutton switch to mute and change volume levels to the headphone.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title18" id="control-description"><h2 class="title topictitle2" id="ariaid-title18">Control Description</h2><div class="body"><p class="p">Button control uses the push button function sequence given in the table below:</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e551"><span><strong class="ph b">Function</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e554"><span><strong class="ph b">Press</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e551 "><span>Volume Control Level 1</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e554 "><span>Low (-66 dB)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e551 "><span>Volume Control Level 2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e554 "><span>Medium (-48 dB)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e551 "><span>Volume Control Level 3</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e554 "><span>High (-0 dB)</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e551 "><span>Mute</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e554 "><span>Mute</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p"><strong class="ph b">Note:</strong> Mute will transition to Volume Control Level 1 on the next button push.</p>
<p class="p">USB operational status is given by LED, as shown below:</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e590"><span><strong class="ph b">LED Status</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d4836e593"><span><strong class="ph b">Status</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e590 "><span>OFF</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e593 "><span>USB cable detached</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e590 "><span>ON</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e593 "><span>USB cable attached</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e590 "><span>Blinking</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d4836e593 "><span>Playback muted</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</body>
</html>