<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="audio_tone_linkeddma" />
<meta name="DC.relation" scheme="URI" content="GUID-408D6777-0172-406B-8442-B97FD5287AC8.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="audio-tone-linkeddma" />
<link rel="stylesheet" type="text/css" href="stylesheets/commonltr.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<link rel="stylesheet" type="text/css" href="./stylesheets/common-extended.css" /><title>audio_tone_linkeddma</title>
<meta name="Microsoft.Help.Id" content="GUID-32F3914E-5B2E-4D3C-898B-3A4760B287C7-audio-tone-linkeddma" />
<meta name="Microsoft.Help.TocParent" content="GUID-32F3914E-5B2E-4D3C-898B-3A4760B287C7" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLABÂ® Harmony Audio Apps Help Reference A 04/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
        function cpy(id, button) {
        
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                    button.textContent = "Copy";
                    button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
              console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
        }
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-C0F1A462-D7AD-4584-A60B-E8B363C87E96"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style></head>
<body id="audio-tone-linkeddma">
<h1 class="title topictitle1" id="ariaid-title1">audio_tone_linkeddma</h1><div class="body"><p class="p">This topic provides instructions and information about the MPLAB Harmony 3 Audio Tone using Linked DMA demonstration application, which is included in the MPLAB Harmony Library distribution.</p>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-408D6777-0172-406B-8442-B97FD5287AC8.html">Harmony 3 audio application examples</a></div>
</div>
</div><div class="topic nested1" aria-labelledby="ariaid-title2" id="description"><h2 class="title topictitle2" id="ariaid-title2">Description</h2><div class="body"><p class="p">In this demonstration application the Codec Driver sets up the WM8904 Codec. The demonstration sends out generated audio waveforms (sine tone) using linked DMA channels with volume and frequency modifiable through the on-board push button. Success is indicated by an audible output corresponding to displayed parameters.</p>
<p class="p">The sine tone is one of four frequencies: 250 Hz, 500 Hz, 1 kHz, and 2 kHz, sent by default at 48,000 samples/second, which is modifiable in the the MHC as described below.</p>
<p class="p">To know more about the MPLAB Harmony Codec Drivers, configuring the Codec Drivers, and the APIs provided by the Codec Drivers, refer to Codec Driver Libraries.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title3" id="architecture"><h2 class="title topictitle2" id="ariaid-title3">Architecture</h2><div class="body"><p class="p">The two projects run on the SAM E70 Xplained Ultra Board, which contains a ATSAME70Q21B microcontroller with 2 MB of Flash memory and 384 KB of RAM running at 300 MHz using the following features:</p>
<ul class="ul"><li class="li"><p class="p">One push button (SW1)</p>
</li>
<li class="li"><p class="p">Two LEDs (LED1 and 2)</p>
</li>
<li class="li"><p class="p">WM8904 Codec Daughter Board mounted on a X32 socket</p>
</li>
</ul>
<p class="p">The SAM E70 Xplained Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.</p>
<p class="p">The program takes up to approximately 1% (17 KB) of the ATSAME70Q21B microcontrollerâs program space. The 16-bit configuration uses 2% (6 KB) of the RAM. No heap is used.</p>
<p class="p">The following figure illustrates the application architecture for the two SAM E70 Xplained Ultra configurations:</p>
<br /><img class="image" src="GUID-AA462637-0403-4A54-BE00-47341D833EA0-low.png" /><br /><p class="p">Depending on the project, either the SSC (Synchronous Serial Controller) or I2SC (Inter-IC Sound Controller) is used with the WM8904 codec, selected by a strapping option on the WM8904 daughterboard. When using the SSC interface, the WM8904 is configured in master mode, meaning it generates the I<sup class="ph sup">2</sup>S clocks (LRCLK and BCLK), and the SSC peripheral is configured as a slave. When using the I2SC interface, the WM8904 is configured in slave mode and the SSC peripheral is a master and generates the I2SC clocks. The other two possibilities (SSC as master and WM8904 as slave, or I2SC as slave and WM8904 as master) are possible, but not discussed.</p>
<p class="p">The same application code is used without change between the two projects.</p>
<p class="p">The SAM E70 microcontroller (MCU) runs the application code, and communicates with the WM8904 codec via an I<sup class="ph sup">2</sup>C interface. The audio interface between the SAM E70 and the WM8904 codec use the I<sup class="ph sup">2</sup>S interface. Audio is configured as 16-bit, 48,000 samples/second, I<sup class="ph sup">2</sup>S format. (16-bit, 48 kHz is the standard rate used for DVD audio. An alternate that could be used is 44,100 samples/second. This is the same sample rate used for CD's. The sample rate is configurable in the MHC.)</p>
<p class="p">The Master Clock (MCLK) signal used by the codec is generated by the Peripheral Clock section of the SAM E70, and is fixed at 12 MHz.</p>
<p class="p">The button and LEDs are interfaced using GPIO pins. There is no screen.</p>
<p class="p">As with any MPLAB Harmony application, the SYS_Initialize function, which is located in the initialization.c source file, makes calls to initialize various subsystems as needed, such as the clock, ports, board support package (BSP), WM8904 codec, I2S, I2C, DMA, timers, and interrupts.</p>
<p class="p">The codec driver and the application state machines are all updated through calls located in the SYS_Tasks function in the tasks.c file.</p>
<p class="p">The application code is contained in the several source files. The applicationâs state machine (APP_Tasks) is contained in app.c. It first initializes the application, which includes APP_Tasks then periodically calls APP_Button_Tasks to process any pending button presses.</p>
<p class="p">Then the application state machine inside APP_Tasks is given control, which first gets a handle to a timer driver instance and sets up a periodic (alarm) callback. In the next state it gets a handle to the codec driver by calling the DRV_CODEC_Open function with a mode of DRV_IO_INTENT_WRITE and sets up the volume.</p>
<p class="p">The application state machine then registers an event handler APP_CODEC_BufferEventHandler as a callback with the codec driver (which in turn is called by the DMA driver).</p>
<p class="p">Two buffers are used for generating a sine wave. Each contains the data for one cycle of audio. One is currently output on a repeated basis, and the second is filled in as necessary when the frequency changes. Then it is designated as the output buffer.</p>
<p class="p">Initially, values for both buffers are calculated in advance. Two calls to the function</p>
<p class="p">DRV_I2S_InitWriteLinkedListTransfer are made each passing the address of one buffer. The buffers are each linked back to themselves such that when one is done, it starts over again. A call to DRV_I2S_StartWriteLinkedListTransfer is made, which starts the DMA sending data using data from the first buffer to the codec.</p>
<p class="p">Only when the frequency is changed, due to a button press, does the second buffer come into play. In that case new values are calculated for the second buffer (while the first buffer continues to be used for output). When the second buffer has been filled in, a call is made to DRV_I2S_WriteNextLinkedListTransfer which transfers control to the second buffer after the first buffer finishes. The way the pointers are set up, it will then repeat on itself until another frequency change is made, and after which control will revert back to the first buffer.</p>
<p class="p">A table called samples contains the number of samples for each frequency that correspond to one cycle of audio (e.g. 48 for 48000 samples/sec, and a 1 kHz tone). <strong class="ph b">Note:</strong> the samples table will need to be modified if changing the sample rate to something other than 48000 samples/second.</p>
<p class="p">This value with the number of samples to be generated is then passed to the function APP_TONE_LOOKUP_TABLE_Initialize along with which buffer to work with (1 or 2) and the sample rate. The 16-bit value for each sample is calculated based on the relative distance (angle) from 0, based in turn on the current sample number and total number of samples for one cycle. First the angle is calculated in radians:</p>
<p class="p">double radians = (M_PI*(double)(360.0/(double)currNumSamples)*(double)i)/180.0;</p>
<p class="p">Then the sample value is calculated using the sine function:</p>
<p class="p">lookupTable<span class="xref"></span>.leftData = (int16_t)(0x7FFF*sin(radians));</p>
<p class="p">If the number of samples divides into the sample rate evenly, then only 1/4 (90Â°) of the samples are calculated, and the remainder is filled in by reflection. Otherwise each sample is calculated individually. Before returning, the size of the buffer is calculated based on the number of samples filled in.</p>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title4" id="demonstration-features"><h2 class="title topictitle2" id="ariaid-title4">Demonstration Features</h2><div class="body"><ul class="ul"><li class="li"><p class="p">Calculation of a sine wave based on the number of samples and sample rate using the sin function</p>
</li>
<li class="li"><p class="p">Uses the Codec Driver Library to write audio samples to the WM8904</p>
</li>
<li class="li"><p class="p">At a lower level, uses the I2S Driver Library between the codec library and the chosen peripheral (SSC or I2SC) to send the audio to the codec</p>
</li>
<li class="li"><p class="p">Use of a alternate buffers (one active, one standby) and linked DMA</p>
</li>
<li class="li"><p class="p">Use of two timers: one as a periodic 1 ms timer for the application for button debouncing, and a second used by the Codec Driver (see Timer Driver Library)</p>
</li>
</ul>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title5" id="tools-setup-differences"><h2 class="title topictitle2" id="ariaid-title5">Tools Setup Differences</h2><div class="body"><p class="p"><strong class="ph b">For projects using the SSC interface and the WM8904 as a Master (the WM8904 codec generates the I<sup class="ph sup">2</sup>S clocks):</strong></p>
<p class="p">When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <em class="ph i">File &gt; New Project</em>. Chose the Configuration name the same based on the BSP used. Select the appropriate processor (ATSAME70Q21B).</p>
<p class="p">In the MHC, under Available Components select the appropriate BSP (SAM E70 Xplained Ultra). Under <em class="ph i">Audio&gt;Templates</em>, double-click on WM8904 Codec. Answer Yes to all questions except for the one regarding FreeRTOS; answer No to that one.</p>
<p class="p">You should end up with a project graph that looks like this, after rearranging the boxes:</p>
<br /><img class="image" src="GUID-2DB768EB-611F-4D6A-A8F7-0D602A355350-low.png" /><br /><p class="p">Click on the WM8904 Driver. In the Configurations Options, set the desired Sample Rate if different from the default (48,000) under Sampling Rate.</p>
<p class="p">If using the SAM E70 Xplained Ultra board, in the Clock Diagram, set MOSCEL to Main Crystal, check the Bypass checkbox, and uncheck the RC Crystal Oscillator and Main Crystal Oscillator boxes, to make use of the 12 MHz external oscillator:</p>
<br /><img class="image" src="GUID-A726E5AE-65BB-4562-90AC-848BE7398A4A-low.png" /><br /><p class="p">In the Clock Diagram, in the PCK2 tab of the <strong class="ph b">Programmable Clock Controller</strong> section, check the On checkbox, and set CSS to MAINCLK (12 MHz). Then check the SSC checkbox in the <strong class="ph b">Peripheral Clock Controller</strong> section.</p>
<p class="p">It is also possible to change the audio format from 16 to 32-bits, and from I2S to Left Justified (SSC only). These changes need to be done in the MHC in both the WM8904, and SSC/I2SC Peripherals. In the current application code (app.h), a #define is also set to the current width.</p>
<p class="p"><strong class="ph b">For projects using the I2SC interface and the WM8904 as a Slave (the SAM E70 generates the I<sup class="ph sup">2</sup>S clocks):</strong></p>
<p class="p">When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <em class="ph i">File &gt; New Project</em>. Chose the Configuration name the based on the BSP. Select the appropriate processor (ATSAME70Q21B). Click Finish.</p>
<p class="p">In the MHC, under Available Components select the BSP SAM E70 Xplained Ultra. Under <em class="ph i">Audio&gt;Templates</em>, double-click on</p>
<p class="p">WM8904 Codec. Answer Yes to all questions. Click on the WM8904 Codec component (<em class="ph i">not</em> the WM8904 Driver). In the Configuration Options, under WM8904 Interface, select I2SC instead of SSC. Answer Yes to all questions except for the one regarding FreeRTOS; answer No to that one.</p>
<p class="p">You should end up with a project graph that looks like this, after rearranging the boxes:</p>
<br /><img class="image" src="GUID-16BC025E-7A74-42B1-A92E-3FDDCB780FF7-low.png" /><br /><p class="p">Click on the WM8904 Driver. In the Configurations Options, under Usage Mode, change Master to Slave. Set the desired Sample Rate if different from the default (48,000) under Sampling Rate.</p>
<p class="p">If using the SAM E70 Xplained Ultra board, in the Clock Diagram, set MOSCEL to Main Crystal, check the Bypass checkbox, and uncheck the RC Crystal Oscillator and Main Crystal Oscillator boxes, to make use of the 12 MHz external oscillator:</p>
<br /><img class="image" src="GUID-A726E5AE-65BB-4562-90AC-848BE7398A4A-low.png" /><br /><p class="p">Also in the Clock Diagram, in the PCK2 tab of the <strong class="ph b">Programmable Clock Controller</strong> section, check the On checkbox, and set CSS to MAINCLK (12 MHz).</p>
<p class="p">The following tables show suggested settings for various sample rates in the Clock Diagram when using the I2SC Peripheral in Master mode. Make sure <strong class="ph b">PLLA Clock</strong> checkbox is checked, and fill in the values for the PLLA Multiplier and Divider boxes. Select the I2S1 tab under <strong class="ph b">Generic Clock Controller</strong>, set GCLKCSS to PLLACK, fill in the Divider value as shown, and check the checkbox next to it.</p>
<br /><img class="image" src="GUID-4D06DE5D-2AF2-49CA-A338-1B705308BB20-low.png" /><br /><p class="p">The values in the first table give the lowest error rate, but have varying PLLACK values so it is best to use the UPPCLKDIV selection for CSS under <strong class="ph b">Master Clock Controller</strong>, for a Processor Clock of 240 MHz.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e231"><span><strong class="ph b">Desired Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e234"><span><strong class="ph b">PLLA Multipler</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e237"><span><strong class="ph b">PLLA Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e240"><span><strong class="ph b">PLLACK</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e243"><span><strong class="ph b">I2SC Generic Clock Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e246"><span><strong class="ph b">Calculated Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e249"><span><strong class="ph b">Error</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e231 "><span>8000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e234 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e237 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e240 "><span>258 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e243 "><span>126</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e246 "><span>7998</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e249 "><span>-0.025%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e231 "><span>16000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e234 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e237 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e240 "><span>258 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e243 "><span>63</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e246 "><span>15997</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e249 "><span>-0.0187%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e231 "><span>44100</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e234 "><span>1</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e237 "><span>16</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e240 "><span>192 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e243 "><span>17</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e246 "><span>41117</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e249 "><span>0.0385%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e231 "><span>48000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e234 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e237 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e240 "><span>258 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e243 "><span>21</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e246 "><span>47991</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e249 "><span>-0.0187%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e231 "><span>96000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e234 "><span>3</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e237 "><span>43</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e240 "><span>172 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e243 "><span>7</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e246 "><span>95982</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e249 "><span>-0.0187%</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p">The values in the second table have somewhat higher error rates, but use a PLLACK value of 294 MHz which is suitable to be used as a Processor Clock (using the PLLACK selection for CSS) which is closer to the maximum of 300 MHz.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e341"><span><strong class="ph b">Desired Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e344"><span><strong class="ph b">PLLA Multipler</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e347"><span><strong class="ph b">PLLA Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e350"><span><strong class="ph b">PLLACK</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e353"><span><strong class="ph b">I2SC Generic Clock Divider</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e356"><span><strong class="ph b">Calculated Sample Rate</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e359"><span><strong class="ph b">Error</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e341 "><span>8000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e344 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e347 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e350 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e353 "><span>144</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e356 "><span>7975</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e359 "><span>-0.3125%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e341 "><span>16000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e344 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e347 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e350 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e353 "><span>72</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e356 "><span>15950</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e359 "><span>-0.3125%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e341 "><span>44100</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e344 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e347 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e350 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e353 "><span>26</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e356 "><span>41170</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e359 "><span>0.1587%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e341 "><span>48000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e344 "><span>2</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e347 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e350 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e353 "><span>24</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e356 "><span>47851</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e359 "><span>-0.3104%</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e341 "><span>96000</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e344 "><span>3</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e347 "><span>49</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e350 "><span>294 MHz</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e353 "><span>12</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e356 "><span>95703</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e359 "><span>-0.3094%</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p">It is also possible to change the audio format from 16 to 32-bits. This changes need to be done in the MHC in both the WM8904 Driver and SSC Peripheral. In the current application code (app.h), a #define is also set to the current width.</p>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title6" id="bulding-the-application"><h3 class="title topictitle3" id="ariaid-title6">Bulding the Application</h3><div class="body"><p class="p">This section identifies the MPLAB X IDE project name and location and lists and describes the available configurations for the demonstration.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p">The parent folder for these files is audio/apps/audio_tone_linkeddma. To build this project, you must open the audio/apps/audio/audio_tone_linkeddma/firmware/*.X project file in MPLAB X IDE that corresponds to your hardware configuration.</p>
</div>
<div class="topic nested3" aria-labelledby="ariaid-title7" id="mplab-x-ide-project-configurations"><h4 class="title topictitle4" id="ariaid-title7">MPLAB X IDE Project Configurations</h4><div class="body"><p class="p">The following table lists and describes supported configurations.</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e464"><span><strong class="ph b">Project Name</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e467"><span><strong class="ph b">BSP Used</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e470"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e464 "><span>audio_tone_ld_sam_e70_xult_wm8904_ssc</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e467 "><span>sam_e70_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e470 "><span>This demonstration runs on the ATSAME70Q21B processor on the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board, using linked DMA. The project configuration is for a sine tone with 16-bit data width, 48000 Hz sampling frequency, and I<sup class="ph sup">2</sup>S audio protocol using the SSC PLIB. The WM8904 codec is configured as the master, and the SSC peripheral as the slave.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e464 "><span>audio_tone_ld_sam_e70_xult_wm8904_i2sc</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e467 "><span>sam_e70_xult</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e470 "><span>This demonstration runs on the ATSAME70Q21B processor on the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board, using linked DMA. The project configuration is for a sine tone with 16-bit data width, 48000 Hz sampling frequency, and I<sup class="ph sup">2</sup>S audio protocol using the I2SC PLIB. The WM8904 codec is configured as the slave, and the I2SC peripheral as the master.</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title8" id="configuring-the-hardware"><h3 class="title topictitle3" id="ariaid-title8">Configuring the Hardware</h3><div class="body"><p class="p">This section describes how to configure the supported hardware.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p">Using the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board, with the SSC PLIB:</p>
<p class="p">All jumpers on the WM8904 should be toward the <strong class="ph b">front</strong>.</p>
<br /><img class="image" src="GUID-E31E3987-AC64-4BA3-8B61-8C261AC543B5-low.png" /><br /><p class="p">Using the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board, with the I2SC PLIB:</p>
<p class="p">All jumpers on the WM8904 should be toward the <strong class="ph b">back</strong>.</p>
<br /><img class="image" src="GUID-FB72E887-227E-4AF6-A024-C72356DC174E-low.png" /><br /><p class="p"><img class="image" src="GUID-9F32F0D4-3E7A-4090-ABBB-C83570B2C40C-low.png" /><br /> <strong class="ph b">Note:</strong> The SAM E70 Xplained Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.</p>
</div>
</div>
<div class="topic nested2" aria-labelledby="ariaid-title9" id="running-the-demonstration"><h3 class="title topictitle3" id="ariaid-title9">Running the Demonstration</h3><div class="body"><p class="p">This section demonstrates how to run the demonstration.</p>
<p class="p"><strong class="ph b">Description</strong></p>
<p class="p"><img class="image" src="GUID-AAE179BC-13D7-4D11-BDB6-31089449D308-low.png" /><br /> <strong class="ph b">Important!</strong> Prior to using this demonstration, it is recommended to review the MPLAB Harmony 3 Release Notes for any known issues.</p>
<p class="p">All configurations:</p>
<p class="p">Continuous sine tones of four frequencies can be generated. <strong class="ph b">Table 1</strong> provides a summary of the button actions that can used to control the volume and frequency.</p>
<p class="p">Compile and program the target device. While compiling, select the appropriate MPLAB X IDE project based. Refer to Building the Applications for details.</p>
<ol class="ol"><li class="li"><span class="indent-level-default">1.</span><p class="p">Connect headphones to the HP OUT jack of the WM8904 Audio Codec Daughter Board (see <strong class="ph b">Figure 1</strong>).</p>
</li>
<li class="li"><span class="indent-level-default">2.</span><p class="p">The tone can be quite loud, especially when using a pair of headphones.</p>
</li>
<li class="li"><span class="indent-level-default">3.</span><p class="p">Initially the program will be in volume-setting mode (LED1 off) at a medium volume setting. Pressing SW1 with LED1 off will cycle through four volume settings (including mute).</p>
</li>
<li class="li"><span class="indent-level-default">4.</span><p class="p">Pressing SW1 longer than one second will change to frequency-setting mode (LED1 on). Pressing SW1 with LED1 on will cycle through four frequency settings -- 250 Hz, 500 Hz, 1 kHz, and 2 kHz.</p>
</li>
<li class="li"><span class="indent-level-default">5.</span><p class="p">Pressing SW1 longer than one second again will switch back to volume-setting mode again (LED1 off).</p>
</li>
</ol>
<br /><img class="image" src="GUID-ADD2455C-C039-48A1-82F3-259109273585-low.png" /><br /><p class="p"><strong class="ph b">Figure 1: WM8904 Audio Codec Daughter Board on SAM E70 Xplained Ultra board</strong></p>
</div>
</div>
</div>
<div class="topic nested1" aria-labelledby="ariaid-title10" id="control-descriptions"><h2 class="title topictitle2" id="ariaid-title10">Control Descriptions</h2><div class="body"></div>
<div class="topic nested2" aria-labelledby="ariaid-title11" id="table-1-button-controls-for-sam-e70-xplained-ultra-board"><h3 class="title topictitle3" id="ariaid-title11">Table 1: Button Controls for SAM E70 Xplained Ultra board</h3><div class="body">
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e586"><span><strong class="ph b">Control</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d1319e589"><span><strong class="ph b">Description</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e586 "><span>SW1 short press</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e589 "><span>If LED1 if off, SW1 cycles through four volume levels (one muted). If LED1 is on, SW1 cycles through four frequencies of sine tone.</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e586 "><span>SW1 long press (&gt; 1 second)</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d1319e589 "><span>Alternates between modes (LED1 on or off).</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</body>
</html>